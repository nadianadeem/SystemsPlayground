name: "Static Code Analysis (x64 Debug & Release C++23)"

env:
  ENABLE_CODEQL: 1  # Set to 1 to enable CodeQL, 0 to disable

on:
  push:
    branches: ["*"]
  pull_request:
    branches: ["*"]
  schedule:
    - cron: '0 6 * * 0'  # Every Sunday at 06:00 UTC
  workflow_dispatch:

jobs:
  analyze:
    name: Analyze (${{ matrix.config }})
    runs-on: windows-latest
    permissions:
      actions: read
      contents: read
      security-events: write

    strategy:
      fail-fast: false
      matrix:
        config: ['Debug', 'Release']

    steps:
      # 1. Checkout the repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. Auto-detect solution file (Supports legacy .sln modern VS2026 .slnx)
      - name: Find solution file
        shell: pwsh
        run: |
          Write-Host "Locating solution file (.sln or .slnx)..."
          $sln = Get-ChildItem -Path . -Filter "*.sln*" -File -Recurse | 
                 Where-Object { $_.Extension -match '^\.slnx?$' } | 
                 Select-Object -First 1

          if ($sln) {
            "SOLUTION_FILE=$($sln.Name)" | Out-File -FilePath $env:GITHUB_ENV -Append
            Write-Host "Located file: $($sln.Name)" -ForegroundColor Green
          } else {
            Write-Host "ERROR: Could not locate a .sln or .slnx file!" -ForegroundColor Red
            exit 1
          }

      # 3. Install LLVM (clang-format & clang-tidy)
      - name: Install LLVM (clang-format & clang-tidy)
        shell: pwsh
        run: |
          Write-Host "Installing LLVM (clang-format & clang-tidy)..."
          choco install llvm --version=20.1.8 -y
          echo "C:\Program Files\LLVM\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          Write-Host "LLVM installation completed"
          clang-format --version
          clang-tidy --version

      # 4. Run clang-format
      - name: Run clang-format
        shell: pwsh
        run: |
          Write-Host "Running clang-format on source files with .clang-format config..."

          # Use git ls-files to get only tracked files (respects .gitignore)
          $files = git ls-files '*.cpp' '*.h' '*.hpp' '*.cc' '*.cxx' | ForEach-Object { 
            Get-Item $_ -ErrorAction SilentlyContinue 
          } | Where-Object { $_ -ne $null }

          if ($files.Count -eq 0) {
            Write-Host "No C++ source files found to check." -ForegroundColor Yellow
            exit 0
          }

          Write-Host "Found $($files.Count) file(s) to check"

          $formattingIssues = @()

          foreach ($file in $files) {
            Write-Host "Checking format: $($file.Name)"

            # Run clang-format in dry-run mode to check for differences
            $output = clang-format --dry-run --Werror $file.FullName 2>&1

            if ($LASTEXITCODE -ne 0) {
              $formattingIssues += $file.FullName
              Write-Host "  ❌ Formatting issues found" -ForegroundColor Red
              Write-Host $output
            } else {
              Write-Host "  ✓ Properly formatted" -ForegroundColor Green
            }
          }

          if ($formattingIssues.Count -gt 0) {
            Write-Host "`n❌ clang-format found formatting issues in $($formattingIssues.Count) file(s):" -ForegroundColor Red
            $formattingIssues | ForEach-Object { Write-Host "  - $_" -ForegroundColor Yellow }
            Write-Host "`nTo fix these issues locally, run:" -ForegroundColor Cyan
            Write-Host "  clang-format -i <file>" -ForegroundColor Cyan
            exit 1
          }

          Write-Host "`n✓ All files are properly formatted!" -ForegroundColor Green

      # 5. Initialize CodeQL
      - name: Initialize CodeQL
        if: env.ENABLE_CODEQL == '1'
        uses: github/codeql-action/init@v4
        with:
          languages: cpp

      # 6. Install Visual Studio 2026 Build Tools
      - name: Install Visual Studio 2026 Build Tools
        shell: pwsh
        run: |
          Write-Host "Installing VS 2026 Build Tools..."
          choco install visualstudio2026buildtools --package-parameters "--add Microsoft.VisualStudio.Workload.VCTools --add Microsoft.VisualStudio.Component.VC.Tools.x86.x64 --includeRecommended --quiet" -y --ignore-package-exit-codes=3010
          Write-Host "VS 2026 Build Tools installation completed"

      # 7. Build the solution (matrix handles Debug/Release)
      - name: Build project (${{ matrix.config }}, x64, C++latest)
        shell: cmd
        run: |
          call "C:\Program Files (x86)\Microsoft Visual Studio\18\BuildTools\Common7\Tools\VsDevCmd.bat"
          echo Building solution (${{ matrix.config }}, x64) with C++latest standard...
          echo Using solution file: %SOLUTION_FILE%
          msbuild /m ^
            /p:Configuration=${{ matrix.config }} ^
            /p:Platform=x64 ^
            /p:LanguageStandard=stdcpplatest ^
            /fl /flp:logfile=msbuild.log ^
            %SOLUTION_FILE%

      # 8. Run clang-tidy using .clang-tidy config
      - name: Run clang-tidy
        shell: pwsh
        run: |
          Write-Host "Running clang-tidy on source files with .clang-tidy config..."

          Write-Host "`nclang-tidy configuration being used:"
          clang-tidy --dump-config

          # Define preprocessor symbols based on configuration (matching MSBuild defaults)
          $defines = "-DWIN32", "-D_WINDOWS"
          if ("${{ matrix.config }}" -eq "Debug") {
            $defines += "-D_DEBUG"
          } else {
            $defines += "-DNDEBUG"
          }

          Write-Host "Using defines: $($defines -join ' ')"

          # Find all .cpp and .h files
          $files = Get-ChildItem -Path . -Include *.cpp,*.h -Recurse | Where-Object { $_.FullName -notmatch '\\build\\|\\bin\\|\\obj\\' }

          $issueCount = 0
          foreach ($file in $files) {
            Write-Host "Checking $($file.FullName)"

            # Determine language mode (treat .h as C++ headers)
            $langFlag = if ($file.Extension -eq ".h") { "-x", "c++-header" } else { @() }

            # Run clang-tidy using .clang-tidy file
            $output = clang-tidy $file.FullName `
              -- `
              $langFlag `
              -std=c++23 `
              -I"$PWD" `
              $defines `
              2>&1

            # Check if clang-tidy found issues
            if ($LASTEXITCODE -ne 0) {
              $issueCount++
              Write-Host "Issues found in $($file.Name)" -ForegroundColor Yellow
              Write-Host $output
            }
          }

          Write-Host "`nclang-tidy completed. Files with issues: $issueCount" -ForegroundColor $(if ($issueCount -gt 0) { "Yellow" } else { "Green" })

          # Fail if any issues were found
          if ($issueCount -gt 0) {
            Write-Host "clang-tidy found issues in $issueCount file(s). Failing the build." -ForegroundColor Red
            exit 1
          }

      # 9. Perform CodeQL Analysis
      - name: Perform CodeQL Analysis
        if: env.ENABLE_CODEQL == '1'
        uses: github/codeql-action/analyze@v4
        with:
          category: "/language:cpp/config:${{ matrix.config }}"

      # 10. Upload build logs for debugging
      - name: Upload build logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs-${{ matrix.config }}
          path: msbuild.log
          retention-days: 7